技术方案
EMS能量管理系统是微服务架构，分成很多的微服务如用户权限，数据采集，数据上报等，服务于服务之间通信复杂，链路状态，错误追踪困难，服务网格就像是一个服务于服务之间的通话的调度员，可以有效的管理服务之间的通信与流量控制。例如在每次在节假日中，各大电站都需频繁的调度，跟更新冲放电计划，届时采集跟上报的数据量巨大，服务网格会智能划分机器给这个两个服务，上报服务需要更多的流量服务，而采集需要计算资源更好的节点，同时还能支持服务自动扩容，保证EMS系统正常稳定的运行。

除了流量管理外，在服务安全与服务监控也发挥了重要的作用，EMS系统在接受远方调度指令或遥控遥调指令调度，防止调度命令的第三方窃取，保证指令调度安全。同时服务与服务之间的通信，
以及数据采集事件和上报事件在这过程中服务网格会自动收集操作日志，链路状态，如果出现问题，会以邮箱的形势将故障内容发送给运维人员，从而得到及时的解决，避免事故发生。同时服务网格可以跟kubernets无缝结合，支持灰度发布， 上线发生故障及时回滚，以前我们是一个大的服务，每次上线都需要停掉整个服务。导致服务在短时间出现中断影响用户使用，使用灰度发布我们可以发布新增的功能不影响其他的服务，大大的降低了系统的迭代风险。服务网格让EMS系统可以应对日均数十万的数据采集和上报工作，使得EMS系统的“储能，光伏， 风电， 电荷”等新能源实现高效协调运行，从而最大能效与经济收益

智光EMS能量管理系统在扩容过程中，曾经面临扩展后资源管理不均匀，导致有些服务遭受大量的流量，高IO高内存的任务导致服务器宕机，系统早期使用一刀切的任务分配计划，计算密集，功率智能调度，被分配到高CPU的服务，内存较高的数据上报分析任务被分配到高内存的机器，早期我们都是通过手动管理，手动切换服务在那台服务上运行，效率低，有次现在运维我们有50多台机器，导致部分服务没有正常分配到高CPU机器导致任务执行延迟了3个多小时，错过了在用电低峰期的时候，没有及时的充电，导致经济损失。后面我们采用了服务网格，根据智能路由，对高内存的任务分配高内存的节点，对高CPU的任务分配高CPU节点，另外我们配置权重路由，实时监控各个节点的负载，动态的分配任务，高紧急的任务流量低负载的节点，使用批量标签，可以使紧急任务需要插队执行，通过以上措施，系统从被动人工管理服务节点，变成了智能管理服务节点，大大的节省了人力资源和节点利用效率。

在通信方面，智光能量管理系统微服务改造过程中，数据传输安全是极大的挑战。其中系统存在智能调控，功率调控，数据采集上报，的信息不能在通信中被人窃取过修改，前期我们使用TLS加密通信，需要手动配置TLS证书，每个节点需要配置通信规约以及静态百名单，在这过程中可以模拟百名单进行数据窃取，极其的不安全。后面我们使用服务网格对系统传输进行改造，使用mTLS通信，mTLS是TLS的升级版本，客户端和服务端都要互相验证对方身份，大大加强了通信的安全，防止数据在传输中被更改，使用SPIFFE做服务身份标识，防止IP和DNS被冒充更改，防止伪造请求，即使攻击者冒充请求也无法冒充服务，使用服务网格对EMS系统进行改造，有效的保障了服务数据在传输的过程保密性和完整性，服务网格将原本散落各地的服务节点，进行统一管理，而且自动配置服务安全通信协议mTLS，加入唯一身份SPIFFE，相比以前不经节省了运维人力成本，并且提高了安全性。

通过服务网格，智光EMS能量管理系统实现了资源自动分配和数据传输统一安全管控，关键技术有，智能路由，权重路由，批次标签， mTLS， SPIFFE，系统成早期资源分配冲突和分配不均到根据流量内存IO自动分配，从手动分配节点到根据策略自动分配，从配置通信协议到统一管理服务节点通信，每一步改变都加强了服务的稳定性安全性跟可靠性，为储能电站高并发运行提供了保障。








